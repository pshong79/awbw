<% event = event.decorate %>

<%= tag.div id: dom_id(event, :card), class: "
  relative bg-white border border-gray-200 rounded-2xl shadow-sm hover:shadow-md
  transition p-4 flex flex-col gap-4
" do %>

  <!-- ðŸ“Œ Bookmark -->
  <div class="absolute top-3 right-3 z-20">
    <%= render "bookmarks/editable_bookmark_icon", resource: event.object %>
  </div>

  <!-- 1ï¸âƒ£ Thumbnail + Title Row -->
  <div class="flex flex-col md:flex-row gap-4">

    <!-- Thumbnail -->
    <div class="flex-shrink-0 w-32 h-24 rounded overflow-hidden bg-gray-100 relative">
      <%= link_to event_path(event), class: "block w-full h-full" do %>
        <div class="absolute inset-0 flex items-center justify-center text-gray-400 text-4xl fallback-icon"
             style="<%= event.main_image_url.present? ? 'display:none;' : 'display:flex;' %>">
          <i class="fa-regular fa-image"></i>
        </div>

        <% if event.main_image_url.present? %>
          <img src="<%= event.main_image_url %>"
               class="object-cover w-full h-full"
               onerror="this.style.display='none'; this.previousElementSibling.style.display='flex';">
        <% end %>
      <% end %>
    </div>

    <!-- Title + badges -->
    <div class="flex flex-col gap-2 flex-1 min-w-0 mr-4 mt-1">
      <%= link_to event_path(event),
                  class: "hover:underline block leading-tight",
                  data: { turbo: false } do %>
        <%= title_with_badges(event, show_hidden_badge: current_user.super_user?).html_safe %>
      <% end %>
    </div>

  </div> <!-- END title row -->

  <!-- 2ï¸âƒ£ TIMES + BUTTONS IN ONE ROW -->
  <div class="times-and-buttons flex flex-wrap items-center justify-between w-full gap-4">

    <!-- LEFT: Times -->
    <div class="text-sm text-gray-700 leading-tight whitespace-pre-line">
      <%= event.times(display_day: true, display_date: true).html_safe %>
    </div>

    <!-- RIGHT: Buttons + Registered -->
    <div class="flex items-center gap-3">

      <% if current_user.super_user? %>
        <%= link_to "Edit",
                    edit_event_path(event),
                    class: "admin-only bg-blue-100 btn btn-secondary-outline" %>
      <% end %>

      <% if event.event_registrations.exists?(registrant_id: current_user.id) %>
        <%= button_to "De-register",
                      event_registrant_registration_path(event_id: event),
                      method: :delete,
                      data: { turbo_confirm: "Are you sure?" },
                      class: "btn btn-secondary-outline" %>
      <% elsif event.registerable? %>
        <%= button_to "Register",
                      event_registrant_registration_path(event_id: event),
                      class: "btn btn-primary-outline" %>
      <% else %>
        <span class="text-sm text-gray-500 italic">Registration closed</span>
      <% end %>

      <% if event.event_registrations.exists?(registrant_id: current_user.id) %>
      <span class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full">
        Registered
      </span>
      <% end %>

    </div>
  </div>

  <!-- 4ï¸âƒ£ FULL-WIDTH CALENDAR LINKS ROW -->
  <% if event.event_registrations.exists?(registrant_id: current_user.id) %>
    <div class="flex gap-2 items-center justify-center w-full text-sm text-gray-700 mt-2">
<!--      <span class="font-semibold">Calendar:</span>-->
      <%= event.calendar_links %>
    </div>
  <% end %>

<% end %>
