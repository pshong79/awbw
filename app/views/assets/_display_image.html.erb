<% resource ||= nil %>
<% item ||= nil %>
<% field_name ||= :primary_asset %>
<% file ||= item&.file || resource&.try(field_name)&.file || file %>

<% variant ||= :gallery %>
<% link_to_object ||= false %>
<% link ||= link_to_object %>
<% display_open_pdf_link ||= false %>
<% idx ||= 0 %>
<% item_type ||= "PrimaryAsset" %>

<% width ||= "32" %>
<% height ||= width %>

<%
  # --------------------------------------------------
  # Normalize file input
  # --------------------------------------------------
  icon_display ||= file.is_a?(Symbol)
  active_storage_file = !icon_display && file.respond_to?(:attached?) && file.attached? ? file : nil
  asset_fallback = file.is_a?(String) ? file : nil

  return unless icon_display || active_storage_file || asset_fallback

  # Tailwind width / height maps
  width_classes = {
  "18"   => "w-18",
  "24"   => "w-24",
  "32"   => "w-32",
  "full" => "w-full"
  }.freeze

  height_classes = {
  "14"   => "h-14",
  "18"   => "h-18",
  "24"   => "h-24",
  "32"   => "h-32",
  "full" => "h-full"
  }.freeze

  width_class  = width_classes.fetch(width.to_s, "w-auto")
  height_class = height_classes.fetch(height.to_s, "h-auto")

  # --------------------------------------------------
  # Variant sizing
  # --------------------------------------------------
  sizes = {
    hero: {
      wrapper: "mb-8",
      image:   "w-full rounded-lg shadow-sm border border-gray-200",
      preview: [1200, 1200]
    },

    gallery: {
      wrapper: "flex grow",
      image:   "#{width_class} #{height_class} object-cover rounded border border-gray-300
                shadow-sm hover:opacity-90 transition-opacity",
      preview: [300, 300]
    },

    index: {
      wrapper: "#{width_class} #{height_class} shrink-0 overflow-hidden rounded border border-gray-300",
      image:   "w-full h-full object-cover"
    }
  }.fetch(variant)

  # --------------------------------------------------
  # Link target
  # --------------------------------------------------
  link_href =
    if link_to_object && resource
      polymorphic_path(resource)
    elsif active_storage_file
      url_for(active_storage_file)
    elsif icon_display
      nil
    else
      asset_path(asset_fallback)
    end
%>

<%#
  --------------------------------------------------
  # Inner content (NO LINKS HERE)
  # --------------------------------------------------
%>

<% inner = capture do %>
  <div class="<%= variant %>-item <%= resource&.class&.table_name %>-<%= idx %> <%= sizes[:wrapper] %>">
    <% if active_storage_file %>
      <% if active_storage_file.previewable? %>
        <%= image_tag(
              active_storage_file.preview(resize_to_limit: sizes[:preview]),
              class: "#{sizes[:image]} hover:opacity-95 transition-opacity",
              alt: "#{item_type} preview #{idx + 1} (#{active_storage_file.blob.filename})"
            ) %>
      <% elsif active_storage_file.content_type == "application/pdf" %>
        <div class="flex items-center gap-3 p-4 border rounded-lg bg-gray-50">
          <i class="fas fa-file-pdf text-red-600 text-2xl"></i>
          <span class="font-medium underline hover:no-underline"><%= active_storage_file.blob.filename %></span>
        </div>
      <% else %>
        <%= image_tag(
              active_storage_file,
              class: "#{sizes[:image]} hover:opacity-95 transition-opacity",
              alt: "#{item_type} image #{idx + 1} (#{active_storage_file.blob.filename})"
            ) %>
      <% end %>
    <% elsif icon_display %>
      <div class="<%= sizes[:image] %> hover:opacity-95 transition-opacity">
        <%= render "assets/display_icon",
                   resource: resource,
                   width: 18,
                   height: 18,
                   variant: variant %>
      </div>
    <% else %>
      <%# ---- Asset fallback (string filename) ---- %>
      <%= image_tag(
            asset_fallback,
            class: sizes[:image],
            alt: "#{item_type} fallback image #{idx + 1}"
          ) %>
    <% end %>
  </div>
<% end %>

<%#
  --------------------------------------------------
  # Optional link wrapper
  # --------------------------------------------------
%>

<% if link && link_href.present? %>
  <% link_options =
      if link_to_object
        { class: "display-image-link", data: { turbo_frame: "_top", turbo_prefetch: false } }
      else
        { class: "display-image-link", target: "_blank", rel: "noopener noreferrer" }
      end %>
  <%= link_to link_href, **link_options do %>
    <%= inner %>
  <% end %>
  <% if active_storage_file&.previewable? &&
        display_open_pdf_link &&
        active_storage_file.content_type == "application/pdf" %>
    <div class="mt-2 text-sm text-gray-600">
      <%= link_to "Open PDF",
                  rails_blob_path(file, disposition: :inline),
                  target: "_blank",
                  rel: "noopener",
                  class: "underline hover:no-underline" %>
    </div>
  <% end %>
<% else %>
  <%= inner %>
<% end %>
