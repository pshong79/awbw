<%= simple_form_for @facilitator, html: { multipart: true, class: "space-y-8" } do |f| %>
  <%= render 'shared/errors', resource: @facilitator if @facilitator.errors.any? %>

  <%= f.hidden_field :created_by_id, value: current_user&.id unless f.object.persisted? %>
  <%= f.hidden_field :updated_by_id, value: current_user&.id %>

  <div class="flex gap-8 items-start">
    <div class="flex-1" style="flex: 0 0 75%;">
      <div class="space-y-6">
        <div class="flex flex-col md:flex-row gap-4">
          <%= f.input :first_name, input_html: { value: f.object.first_name || @user&.first_name } %>
          <%= f.input :last_name, input_html: { value: f.object.last_name || @user&.last_name } %>
          <%= f.input :pronouns %>
        </div>

        <div class="flex flex-col md:flex-row gap-4">
          <%= f.input :date_of_birth,
                      as: :string,
                      input_html: {
                        type: "date",
                        class: "w-full rounded-md border-gray-300 shadow-sm
                      focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50"
                      } %>
                      <% if current_user.super_user? %>
                        <%= f.input :member_since,
                                    as: :string,
                                    label: "Facilitator since",
                                    hint: "Pick Jan 1 if you only know the year",
                                    input_html: {
                                      type: "date",
                                      class: "w-full rounded-md border-gray-300 shadow-sm admin-only bg-blue-100 border-blue-200
                                      focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50"
                                    } %>
                      <% else %>
                        <div>
                          <label class="block text-md font-medium text-gray-700 mb-1">
                            Facilitator since
                          </label>
                          <span class="text-gray-900 font-medium">
                            <%= f.object.member_since&.to_date&.strftime("%B %d, %Y") || "—" %>
                          </span>
                        </div>
                      <% end %>
        </div>
      </div>
    </div>

    <!-- Avatar -->
    <div class="flex flex-col items-center gap-4" style="flex: 0 0 25%;">
      <%= render "shared/form_image_field", f: f, field_name: :avatar %>
    </div>
  </div>

  <div class="emails">
    <h3 class="font-semibold text-gray-700 mb-2">Emails</h3>
    <div class="rounded-lg border border-gray-200 bg-gray-50 p-4 mb-4 shadow-sm">
      <div class="flex flex-col md:flex-row gap-4">
        <% if f.object.user %>
          <div>
            <label class="block text-md font-medium text-gray-700 mb-1">Primary email</label>
            <span class="text-gray-900 font-medium">
              <%= f.object.user&.email || f.object.email %>
            </span>
            <p class="text-sm text-gray-500 mt-1">Only
              <% if current_user.super_user? && f.object.user&.persisted? %>
                <%= link_to "editable by admins",
                            edit_user_path(f.object.user),
                            class: "underline" %>
              <% else %>
                editable by admins
              <% end %>
            </p>
          </div>
          <div>
            <label class="block text-md font-medium text-gray-700 mb-1">Email type</label>
            <span class="text-gray-900 font-medium">
              <%= f.object.user&.email_type || f.object.email_type %>
            </span>
          </div>
        <% else %>
          <%= f.input :email, label: "Primary email" %>
          <%= f.input :email_type,
                      label: "Primary email type",
                      as: :select,
                      collection: Facilitator::CONTACT_TYPES.compact.map{|type| [type.to_s.humanize, type]} %>
        <% end %>
        <%= f.input :email_2, label: "Secondary email" %>
        <%= f.input :email_2_type,
                    label: "Secondary email type",
                    as: :select,
                    collection: Facilitator::CONTACT_TYPES.compact.map{|type| [type.to_s.humanize, type]} %>
      </div>
    </div>
  </div>

  <div class="phones">
    <div class="form-group space-y-4">
      <div class="font-semibold text-gray-700">
        Phones
      </div>
      <div class="rounded-lg border border-gray-200 bg-gray-50 p-4 mb-4 shadow-sm">
        <%= f.input :best_time_to_call %>
        <%= f.simple_fields_for :contact_methods do |f| %>
          <%= render "contact_methods/contact_method_fields", f: f %>
        <% end %>

        <%= link_to_add_association "➕ Add phone",
                                    f,
                                    :contact_methods,
                                    class: "btn btn-secondary-outline" %>
      </div>
    </div>
  </div>

  <div class="addresses">
    <!-- Primary Address Choice -->
    <div class="flex flex-col md:flex-row gap-4">
      <%#= f.input :primary_address, collection: [['Work', 1], ['Home', 2]], prompt: "Select Primary Address" %>
    </div>

    <div class="form-group space-y-4">
      <div class="font-semibold text-gray-700">
        Addresses
      </div>
      <div class="rounded-lg border border-gray-200 bg-gray-50 p-4 mb-4 shadow-sm">

        <%= f.simple_fields_for :addresses do |f| %>
          <%= render "addresses/address_fields", f: f %>
        <% end %>

        <%= link_to_add_association "➕ Add address",
                                    f,
                                    :addresses,
                                    class: "btn btn-secondary-outline" %>
      </div>
    </div>
  </div>

  <!-- USER FIELDS -->
  <%= f.fields_for :user do |u| %>
    <%= u.hidden_field :facilitator_id, value: f.object.id %>

    <!-- Organization Connections (PROJECT_USERS) -->
    <div class="form-group space-y-4">
      <div class="font-semibold text-gray-700">
        Organizational affiliations
        <span class="text-sm font-normal text-gray-500">(only editable by admins)</span>
      </div>
      <div class="rounded-lg border border-gray-200 bg-gray-50 p-4 mb-4 shadow-sm">
        <% if current_user.super_user? %>
          <div class="admin-only bg-blue-100 p-3">
            <%= u.fields_for :project_users do |project_user_form| %>
              <%= render "project_user_fields",
                         f: project_user_form,
                         projects: u.object.projects,
                         user: u.object %>
            <% end %>

            <div class="admin-only bg-blue-100 p-3 mt-6">
              <%= link_to_add_association "➕ Add Role",
                                          u,
                                          :project_users,
                                          html_options: { locals: { projects: u.object.projects } },
                                          class: "btn btn-secondary-outline" %>
            </div>
          </div>
        <% else %>
          <% f.object.user && f.object.user.project_users.each do |pu| %>
            <div class="ps-6 mb-2">
              <li><%= pu.title || pu.position %> - <%= pu.persisted? ? (link_to pu.project&.name,
                                                               project_path(pu.project),
                                                               class: "underline") : pu.project&.name %></li>
            </div>
          <% end %>
        <% end %>
      </div>
    </div>
  <% end %>

  <div class="form-group space-y-4">
    <div class="font-semibold text-gray-700">
     Service populations
    </div>
    <div class="rounded-lg border border-gray-200 bg-gray-50 p-4 mb-4 shadow-sm">
        <div class="flex flex-wrap items-center gap-4 p-3">
          <%= f.simple_fields_for :sectorable_items do |sfi| %>
            <%= render "sectorable_item_fields", f: sfi %>
          <% end %>
        </div>
        <%= link_to_add_association "➕ Add Sector",
                                    f,
                                    :sectorable_items,
                                    render_options: {
                                      locals: {
                                        collection: Sector.published.where.not(name: f.object.sector_list)
                                      }
                                    },
                                    class: "btn btn-secondary-outline" %>
      </div>
  </div>


  <!-- FACILITATOR FIELDS -->
  <div class="space-y-6">
    <%= f.input :bio,
                as: :text,
                input_html: {
                  rows: 2,
                  maxlength: 1650,
                  class: "w-full rounded-md border-gray-300 shadow-sm
                      focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50"
                },
                hint: "Maximum 250 characters" %>
  </div>

  <div class="profile-preferences-section">
    <div class="font-medium text-gray-700 mb-3 block">
      Social media links:
    </div>
    <div class="rounded-lg border border-gray-200 bg-gray-50 p-4 mb-4 shadow-sm">
      <div class="flex flex-col md:flex-row gap-4 pl-3 pr-3 pb-3">
        <%= f.input :linked_in_url, as: :text, input_html: { rows: 1 } %>
        <%= f.input :facebook_url, as: :text, input_html: { rows: 1 } %>
        <%= f.input :instagram_url, as: :text, input_html: { rows: 1 } %>
        <%= f.input :youtube_url, as: :text, input_html: { rows: 1 } %>
        <%= f.input :twitter_url, as: :text, input_html: { rows: 1 } %>
      </div>
    </div>
  </div>

  <div class="profile-preferences-section">
    <div class="font-medium text-gray-700 mb-3 block">
      Profile display preferences:
    </div>

    <div class="rounded-lg border border-gray-200 bg-gray-50 p-4 mb-4 shadow-sm">
      <div class="pl-3 pr-3 pb-3">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mt-3">
        <%= f.input :profile_is_searchable,
                    hint: ("Findable on " + (link_to "facilitators index",
                                                    facilitators_path,
                                                    class: "underline")).html_safe %>

        <%= f.input :display_name_preference,
                    as: :select,
                    collection: [
                      ["First and Last Name", "full_name"],
                      ["First Name and Last Initial", "first_name_last_initial"],
                      ["First Name Only", "first_name_only"],
                      ["Last Name Only", "last_name_only"]
                    ],
                    selected: f.object.display_name_preference || "full_name" %>

        <%= f.input :profile_show_pronouns, label: "Show pronouns" %>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mt-3">
        <%= f.input :profile_show_email, label: "Show email" %>
        <%= f.input :profile_show_phone, label: "Show phone" %>
        <%= f.input :profile_show_social_media, label: "Show social media" %>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mt-3">
        <%= f.input :profile_show_member_since, label: "Show facilitator since" %>
        <%= f.input :profile_show_bio, label: "Show bio" %>
        <%= f.input :profile_show_affiliations, label: "Show affiliations" %>
        <%= f.input :profile_show_sectors, label: "Show sectors" %>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mt-3">
        <%= f.input :profile_show_workshops, label: "Show workshops" %>
        <%= f.input :profile_show_workshop_variations, label: "Show workshop variations" %>
        <%= f.input :profile_show_stories, label: "Show stories" %>
        <%= f.input :profile_show_events_registered, label: "Show participation" %>
      </div>

      <!-- Row 5 -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mt-3">
        <%= f.input :profile_show_workshop_ideas, label: "Show workshop ideas" %>
        <%= f.input :profile_show_story_ideas, label: "Show story ideas" %>
        <%= f.input :profile_show_workshop_logs, label: "Show workshop logs" %>
      </div>
    </div>
    </div>
  </div>


  <!-- Actions -->
  <div class="mt-6 flex flex-wrap gap-3">
    <% if @facilitator.persisted? && current_user.super_user? %>
      <%= link_to "Delete", @facilitator, method: :delete,
                  data: { confirm: "Are you sure?" },
                  class: "btn btn-danger-outline" %>
    <% end %>
    <%= link_to "Cancel", facilitators_path, class: "btn btn-secondary-outline" %>
    <%= f.submit "Submit", class: "btn btn-primary" %>
  </div>
<% end %>
