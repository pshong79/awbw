<% profile_url = @facilitator ? facilitator_url(@facilitator) : user_url(@user) %>
<% breakdown = @noticeable.attendance_breakdown %>
<% totals = @noticeable.totals %>

<div>
  <p style="margin-bottom: 6px;">
    New <%= @type %>
  </p>

  <h1 style="margin: 0;">
    <strong><%= @user.name %></strong><br>
  </h1>

  <p style="margin: 4px 0 16px; font-size: 13px; color: #6b7280;">
    <span style="color:#6b7280; font-size: 0.9em;">
      Submitted on
    <%= @noticeable.created_at
                   .in_time_zone("Pacific Time (US & Canada)")
                   .strftime("%B %-d, %Y at %-l:%M %p %Z") %>
    </span>
  </p>

  <hr style="margin: 24px 0;">

  <div style="text-align: left;">

    <% if @report.present? %>


      <!-- Report details -->
      <h2 style="margin-bottom: 12px; text-align: left;">
        WorkshopLog details
      </h2>

      <div class="text-align: left;">
        <span style="color:#6b7280;">Workshop:</span>
        <%= @noticeable.workshop.title %>
      </div>

      <div class="text-align: left;">
        <span style="color:#6b7280;">Service population:</span>
        <%= @noticeable.windows_type.short_name %>
      </div>

      <h3 style="margin-top: 36px; margin-bottom: 8px; text-align:left;">
        Participants
      </h3>

      <table width="100%" cellpadding="0" cellspacing="0"
             style="border-collapse:collapse;margin-top:12px;">

        <!-- Header -->
        <tr style="background:#f5f5f5;font-weight:bold;">
          <td style="border:1px solid #ddd;padding:6px;">Participants</td>
          <td style="border:1px solid #ddd;padding:6px;">Children</td>
          <td style="border:1px solid #ddd;padding:6px;">Teens</td>
          <td style="border:1px solid #ddd;padding:6px;">Adults</td>
          <td style="border:1px solid #ddd;padding:6px;">Total</td>
        </tr>

        <!-- First-time row -->
        <tr>
          <td style="border:1px solid #ddd;padding:6px;font-weight:bold;">
            First-time
          </td>
          <td style="border:1px solid #ddd;padding:6px;">
            <%= breakdown[:children][:first] %>
          </td>
          <td style="border:1px solid #ddd;padding:6px;">
            <%= breakdown[:teens][:first] %>
          </td>
          <td style="border:1px solid #ddd;padding:6px;">
            <%= breakdown[:adults][:first] %>
          </td>
          <td style="border:1px solid #ddd;padding:6px;">
            <%= totals[:first_time] %>
          </td>
        </tr>

        <!-- Ongoing row -->
        <tr>
          <td style="border:1px solid #ddd;padding:6px;font-weight:bold;">
            Ongoing
          </td>
          <td style="border:1px solid #ddd;padding:6px;">
            <%= breakdown[:children][:ongoing] %>
          </td>
          <td style="border:1px solid #ddd;padding:6px;">
            <%= breakdown[:teens][:ongoing] %>
          </td>
          <td style="border:1px solid #ddd;padding:6px;">
            <%= breakdown[:adults][:ongoing] %>
          </td>
          <td style="border:1px solid #ddd;padding:6px;">
            <%= totals[:ongoing] %>
          </td>
        </tr>

        <!-- Overall total -->
        <tr style="font-weight:bold;background:#fafafa;">
          <td style="border:1px solid #ddd;padding:6px;">
            Total
          </td>
          <td style="border:1px solid #ddd;padding:6px;">
            <%= breakdown[:children][:first] + breakdown[:children][:ongoing] %>
          </td>
          <td style="border:1px solid #ddd;padding:6px;">
            <%= breakdown[:teens][:first] + breakdown[:teens][:ongoing] %>
          </td>
          <td style="border:1px solid #ddd;padding:6px;">
            <%= breakdown[:adults][:first] + breakdown[:adults][:ongoing] %>
          </td>
          <td style="border:1px solid #ddd;padding:6px;">
            <%= totals[:overall] %>
          </td>
        </tr>

      </table>

      <!-- Form answers -->
      <% if @answers.present? %>
        <h3 style="margin-top: 36px; margin-bottom: 8px; text-align: left;">
          Form answers
        </h3>

        <% @answers.each do |answer| %>
          <div style="margin-bottom: 18px; text-align: left;">
            <p style="margin: 0 0 4px 0; font-weight: bold;">
              <%= answer.name %>
            </p>
            <p style="margin: 0; color:#374151;">
              <%= answer.answer.presence || "—" %>
            </p>
          </div>
        <% end %>

        <hr style="margin: 24px 0;">
      <% end %>

      <!-- Quotes -->
      <% if @quotes.present? %>
        <h3 style="margin-top: 36px; margin-bottom: 8px; text-align: left;">
          Quotes
        </h3>
        <ul>
          <% @quotes.decorate.each do |quote| %>
            <li>
              “<%= quote.detail %>”
              <% if quote.attribution.present? %>
              <span style="color:#6b7280; font-style: italic;">
                — <%= quote.attribution %>
              </span>
              <% end %>
            </li>
          <% end %>
        </ul>
      <% end %>

      <!-- Attachments -->
      <% if @attachments.present? %>
        <h3 style="margin-top: 36px; margin-bottom: 12px;">
          Attachments
        </h3>

        <% @attachments.each do |asset| %>
          <% blob = asset.file.blob %>

          <span style="margin-bottom: 6px;">
            <a
              href="<%= rails_blob_url(blob, disposition: "inline") %>"
              target="_blank"
              style="color:#2563eb; text-decoration: underline;"
            >
              <% if blob.image? %>
                <a href="<%= rails_blob_url(blob, disposition: "inline") %>" target="_blank">
                  <img
                    src="<%= rails_blob_url(blob, disposition: "inline") %>"
                    alt="<%= blob.filename %>"
                    width="180"
                    style="display:block;margin:6px 0;border-radius:4px;"
                    />
                  <%= blob.filename.to_s %>
                </a>
              <% else %>
                <%= blob.filename.to_s %>
              <% end %>
            </a>
          </span>
        <% end %>
      <% end %>
    <% end %>
  </div>

  <hr style="margin: 24px 0;">

  <p>
    <%= link_to "View workshop log",
                workshop_log_url(@report),
                style: "display:inline-block;
                        padding:10px 16px;
                        background:#2563eb;
                        color:#ffffff;
                        text-decoration:none;
                        border-radius:6px;
                        font-weight:bold;" if @report.present? %>
    <a href="<%= profile_url %>"
       style="display:inline-block;background:#e5e7eb;color:#111827;
         text-decoration:none;padding:10px 16px;border-radius:6px;
         font-weight:bold;">
      View profile
    </a>
  </p>
</div>
