<%# app/views/stories/_story_card.html.erb %>
<%# locals: story:, href: story_path(story) by default, show_meta: true, show_excerpt: true %>
<% href       = local_assigns.fetch(:href,
                                    story_path(story),
                                    target: story.external_link? ? "_blank" : "", rel: "noopener noreferrer") %>
<% show_meta  = local_assigns.fetch(:show_meta, true) %>
<% show_excerpt = local_assigns.fetch(:show_excerpt, true) %>

<article class="w-full">
  <%= link_to href, data: { turbo_prefetch: false }, class: "group block focus:outline-none" do %>
    <%# Cover image (16:9), no border %>
    <% if story.respond_to?(:primary_asset) && story.primary_asset&.file&.attached? %>
      <% cover = story.primary_asset.file %>
    <% elsif story.respond_to?(:images) && story.images.first&.file&.attached? %>
      <% cover = story.images.attachments.first.file %>
    <% end %>

    <% if defined?(cover) && cover.present? %>
      <%= image_tag cover.variant(resize_to_fill: [1600, 900]),
                    class: "w-full aspect-[16/9] object-cover object-center transition group-hover:opacity-95" %>
    <% end %>

    <div class="py-4">
      <h3 class="text-2xl font-bold tracking-tight text-gray-900 group-hover:underline">
        <%= story.title.presence || "Untitled Story" %>
      </h3>

      <% if show_meta %>
        <p class="mt-1 text-sm text-gray-600">
          <% if story.respond_to?(:organization_name) && story.organization_name.present? %>
            <span class="font-medium"><%= story.organization_name %></span>
            <% if story.respond_to?(:organization_locality) && story.organization_locality.present? %>, <%= story.organization_locality %><% end %>
            <% if story.respond_to?(:workshop) && story.workshop&.title.present? %> Â· <span>Workshop: <%= story.workshop.title %></span><% end %>
          <% elsif story.respond_to?(:workshop) && story.workshop&.title.present? %>
            <span>Workshop: <%= story.workshop.title %></span>
          <% end %>
        </p>
      <% end %>

      <% if show_excerpt %>
        <p class="mt-3 text-gray-700">
          <%= strip_tags(story.rhino_body.to_s).truncate(200) %>
        </p>
      <% end %>
    </div>
  <% end %>
</article>
