FROM ruby:4.0.1-bookworm

# Install basic Linux packages
RUN apt-get update -qq && apt-get install -y \
  build-essential \
  git \
  curl \
  default-libmysqlclient-dev \
  imagemagick \
  libvips \
  tzdata \
  libxml2-dev \
  libxslt1-dev \
  libffi-dev \
  libreadline-dev \
  libssl-dev \
  zlib1g-dev \
  nodejs \
  npm \
  default-mysql-client

# Set working directory
WORKDIR /app

# Install bundler
# RUN gem install bundler -v 4.0.4

# Speed up bundling by caching Gemfile layer
ENV BUNDLE_PATH=/usr/local/bundle \
    BUNDLE_BIN=/usr/local/bundle/bin \
    GEM_HOME=/usr/local/bundle
ENV PATH="$BUNDLE_BIN:$PATH"

COPY Gemfile Gemfile.lock package.json package-lock.json ./
RUN npm ci
RUN bundle install

# Bring in the rest of the app (still useful for initial build cache)
COPY . .

# Rails dev defaults
ENV RAILS_ENV=development
ENV NODE_ENV=development

# Expose port (default Rails)
EXPOSE 3000

# Start the server (customize to your app server if needed)
CMD ["bundle", "exec", "rails", "server", "-b", "0.0.0.0"]
