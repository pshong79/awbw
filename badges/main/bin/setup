#!/usr/bin/env ruby
require "fileutils"

APP_ROOT = File.expand_path("..", __dir__)

def system!(*args)
  system(*args, exception: true)
end

# def run_sql_file(path)
#   puts "== Running SQL file: #{path} =="
#
#   config = ActiveRecord::Base.connection_db_config.configuration_hash
#
#   command = [
#     db_client,
#     "-h", config[:host] || "127.0.0.1",
#     "-P", (config[:port] || 3306).to_s,
#     "-u", config[:username] || "root",
#     "-D", config[:database]
#   ].join(" ")
#
#   command << " -p#{config[:password]}" if config[:password]
#
#   # Use shell input redirection
#   system!("#{command} < #{path}")
#   puts "âœ“ Successfully executed #{path}"
# rescue => e
#   puts "Warning: failed to run #{path}: #{e.message}"
# end

# Choose mariadb or mysql client
def db_client
  if system("command -v mariadb > /dev/null", out: File::NULL)
    "mariadb"
  elsif system("command -v mysql > /dev/null", out: File::NULL)
    "mysql"
  else
    raise "No MySQL/MariaDB client found on PATH. Install mariadb-clients or mysql-client."
  end
end

# ------------------------------------------------------------------------------
# Main setup sequence
# ------------------------------------------------------------------------------
FileUtils.chdir APP_ROOT do
  require_relative "../config/environment"

  puts "== Installing dependencies =="
  system("bundle check") || system!("bundle install")

  if File.exist?("package.json")
    puts "\n== Installing npm packages =="
    system!("npm install")
  end

  puts "\n== Preparing database =="
  system! "bin/rails db:drop"
  system! "bin/rails db:create"

  # puts "\n== Running SQL files in db/init =="
  # Dir["db/init/*.sql"].sort.each { |file| run_sql_file(file) }

  puts "\n== Running Rails migrations and seeds =="
  system! "bin/rails db:migrate"
  system! "bin/rails db:seed"

  puts "\n== Preparing test database =="
  system! "RAILS_ENV=test bin/rails db:drop"
  system! "RAILS_ENV=test bin/rails db:create"
  system! "RAILS_ENV=test bin/rails db:migrate"

  puts "\n== Cleaning logs and tempfiles =="
  system! "bin/rails log:clear tmp:clear"

  unless ARGV.include?("--skip-server")
    puts "\n== Starting development server =="
    STDOUT.flush
    exec "mise server"
  end
end
